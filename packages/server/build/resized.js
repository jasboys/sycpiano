import arp from "app-root-path";
import bluebird from "bluebird-global";
import express from "express";
import * as fs from "fs";
import * as path from "path";
globalThis.Promise = bluebird;
const root = arp.toString();
import { mkdirp } from "mkdirp";
import Sharp from "sharp";
const statAsync = Promise.promisify(fs.stat);
const resized = express();
resized.get('/*', async (req, res)=>{
    let imgPath = req.params[0];
    if (!imgPath) {
        res.status(404).end();
    }
    if (process.env.IMAGE_ASSETS_DIR === undefined) {
        throw new Error('Missing env vars');
    }
    imgPath = path.join(process.env.IMAGE_ASSETS_DIR, imgPath);
    const w = req.query.width === undefined ? undefined : parseInt(req.query.width, 10);
    const h = req.query.height === undefined ? undefined : parseInt(req.query.height, 10);
    const sendFileAsync = Promise.promisify(res.sendFile);
    if (!w && !h) {
        try {
            await sendFileAsync.call(res, imgPath, {
                maxAge: 31536000
            });
            res.end();
        } catch (e) {
            console.error(e);
        }
    } else {
        const parsedPath = path.parse(req.params[0]);
        const width = w ? `w${w}` : undefined;
        const height = h ? `h${h}` : undefined;
        const filename = `${parsedPath.name}.${width}${height}${parsedPath.ext}`;
        const newDir = path.join(root, '.resized-cache/', parsedPath.dir);
        try {
            await mkdirp(newDir);
            const newPath = path.join(newDir, filename);
            try {
                await statAsync(newPath);
                try {
                    await sendFileAsync.call(res, newPath, {
                        maxAge: 31536000
                    });
                    res.end();
                } catch (e) {
                    console.error(e);
                }
            } catch (_) {
                try {
                    await Sharp(imgPath).resize(w, h, {
                        fit: 'inside',
                        withoutEnlargement: true
                    }).toFile(newPath);
                } catch (e) {
                    const parsedImg = path.parse(imgPath);
                    const jpegPath = `${parsedImg.dir}/${parsedImg.name}.jpg`;
                    try {
                        await statAsync(jpegPath);
                        await Sharp(jpegPath).resize(w, h, {
                            fit: 'inside',
                            withoutEnlargement: true
                        }).webp().toFile(newPath);
                    } catch (e) {
                        console.error(e);
                    }
                }
                await sendFileAsync.call(res, newPath, {
                    maxAge: 31536000
                });
                res.end();
            }
        } catch (e) {
            console.error(e);
        }
    }
});
export const Resized = resized;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXNpemVkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhcnAgZnJvbSAnYXBwLXJvb3QtcGF0aCc7XHJcbmltcG9ydCBibHVlYmlyZCBmcm9tICdibHVlYmlyZC1nbG9iYWwnO1xyXG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5cclxuZ2xvYmFsVGhpcy5Qcm9taXNlID0gKGJsdWViaXJkIGFzIGFueSk7XHJcblxyXG5jb25zdCByb290ID0gYXJwLnRvU3RyaW5nKCk7XHJcblxyXG5pbXBvcnQgeyBPdXRnb2luZ0h0dHBIZWFkZXJzIH0gZnJvbSAnaHR0cCc7XHJcbmltcG9ydCB7IG1rZGlycCB9IGZyb20gJ21rZGlycCc7XHJcbmltcG9ydCBTaGFycCBmcm9tICdzaGFycCc7XHJcblxyXG5jb25zdCBzdGF0QXN5bmMgPSBQcm9taXNlLnByb21pc2lmeShmcy5zdGF0KTtcclxuXHJcbmNvbnN0IHJlc2l6ZWQgPSBleHByZXNzKCk7XHJcblxyXG5yZXNpemVkLmdldCgnLyonLCBhc3luYyAocmVxOiBleHByZXNzLlJlcXVlc3Q8c3RyaW5nW10sIGFueSwgYW55LCB7IHdpZHRoPzogc3RyaW5nOyBoZWlnaHQ/OiBzdHJpbmcgfT4sIHJlcykgPT4ge1xyXG4gICAgbGV0IGltZ1BhdGggPSByZXEucGFyYW1zWzBdO1xyXG4gICAgaWYgKCFpbWdQYXRoKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg0MDQpLmVuZCgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHByb2Nlc3MuZW52LklNQUdFX0FTU0VUU19ESVIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBlbnYgdmFycycpO1xyXG4gICAgfVxyXG4gICAgaW1nUGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmVudi5JTUFHRV9BU1NFVFNfRElSLCBpbWdQYXRoKTtcclxuXHJcbiAgICBjb25zdCB3ID0gKHJlcS5xdWVyeS53aWR0aCA9PT0gdW5kZWZpbmVkKSA/IHVuZGVmaW5lZCA6IHBhcnNlSW50KHJlcS5xdWVyeS53aWR0aCwgMTApO1xyXG4gICAgY29uc3QgaCA9IChyZXEucXVlcnkuaGVpZ2h0ID09PSB1bmRlZmluZWQpID8gdW5kZWZpbmVkIDogcGFyc2VJbnQocmVxLnF1ZXJ5LmhlaWdodCwgMTApO1xyXG5cclxuICAgIGNvbnN0IHNlbmRGaWxlQXN5bmMgPSBQcm9taXNlLnByb21pc2lmeTxQcm9taXNlPHZvaWQ+LCBzdHJpbmcsIE91dGdvaW5nSHR0cEhlYWRlcnM+KHJlcy5zZW5kRmlsZSk7XHJcblxyXG4gICAgaWYgKCF3ICYmICFoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgc2VuZEZpbGVBc3luYy5jYWxsKHJlcywgaW1nUGF0aCwgeyBtYXhBZ2U6IDMxNTM2MDAwIH0pO1xyXG4gICAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IHBhcnNlZFBhdGggPSBwYXRoLnBhcnNlKHJlcS5wYXJhbXNbMF0pO1xyXG4gICAgICAgIGNvbnN0IHdpZHRoID0gdyA/IGB3JHt3fWAgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gaCA/IGBoJHtofWAgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBgJHtwYXJzZWRQYXRoLm5hbWV9LiR7d2lkdGh9JHtoZWlnaHR9JHtwYXJzZWRQYXRoLmV4dH1gO1xyXG4gICAgICAgIGNvbnN0IG5ld0RpciA9IHBhdGguam9pbihyb290LCAnLnJlc2l6ZWQtY2FjaGUvJywgcGFyc2VkUGF0aC5kaXIpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IG1rZGlycChuZXdEaXIpO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5qb2luKG5ld0RpciwgZmlsZW5hbWUpO1xyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHN0YXRBc3luYyhuZXdQYXRoKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHNlbmRGaWxlQXN5bmMuY2FsbChyZXMsIG5ld1BhdGgsIHsgbWF4QWdlOiAzMTUzNjAwMCB9KTtcclxuICAgICAgICAgICAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoXykge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBTaGFycChpbWdQYXRoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucmVzaXplKHcsIGgsIHsgZml0OiAnaW5zaWRlJywgd2l0aG91dEVubGFyZ2VtZW50OiB0cnVlIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50b0ZpbGUobmV3UGF0aCk7XHJcblxyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnNlZEltZyA9IHBhdGgucGFyc2UoaW1nUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QganBlZ1BhdGggPSBgJHtwYXJzZWRJbWcuZGlyfS8ke3BhcnNlZEltZy5uYW1lfS5qcGdgO1xyXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHN0YXRBc3luYyhqcGVnUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IFNoYXJwKGpwZWdQYXRoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlc2l6ZSh3LCBoLCB7IGZpdDogJ2luc2lkZScsIHdpdGhvdXRFbmxhcmdlbWVudDogdHJ1ZSB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLndlYnAoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRvRmlsZShuZXdQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGF3YWl0IHNlbmRGaWxlQXN5bmMuY2FsbChyZXMsIG5ld1BhdGgsIHsgbWF4QWdlOiAzMTUzNjAwMCB9KTtcclxuICAgICAgICAgICAgICAgIHJlcy5lbmQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuZXhwb3J0IGNvbnN0IFJlc2l6ZWQgPSByZXNpemVkO1xyXG4iXSwibmFtZXMiOlsiYXJwIiwiYmx1ZWJpcmQiLCJleHByZXNzIiwiZnMiLCJwYXRoIiwiZ2xvYmFsVGhpcyIsIlByb21pc2UiLCJyb290IiwidG9TdHJpbmciLCJta2RpcnAiLCJTaGFycCIsInN0YXRBc3luYyIsInByb21pc2lmeSIsInN0YXQiLCJyZXNpemVkIiwiZ2V0IiwicmVxIiwicmVzIiwiaW1nUGF0aCIsInBhcmFtcyIsInN0YXR1cyIsImVuZCIsInByb2Nlc3MiLCJlbnYiLCJJTUFHRV9BU1NFVFNfRElSIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJqb2luIiwidyIsInF1ZXJ5Iiwid2lkdGgiLCJwYXJzZUludCIsImgiLCJoZWlnaHQiLCJzZW5kRmlsZUFzeW5jIiwic2VuZEZpbGUiLCJjYWxsIiwibWF4QWdlIiwiZSIsImNvbnNvbGUiLCJlcnJvciIsInBhcnNlZFBhdGgiLCJwYXJzZSIsImZpbGVuYW1lIiwibmFtZSIsImV4dCIsIm5ld0RpciIsImRpciIsIm5ld1BhdGgiLCJfIiwicmVzaXplIiwiZml0Iiwid2l0aG91dEVubGFyZ2VtZW50IiwidG9GaWxlIiwicGFyc2VkSW1nIiwianBlZ1BhdGgiLCJ3ZWJwIiwiUmVzaXplZCJdLCJtYXBwaW5ncyI6IkFBQUEsT0FBT0EsU0FBUyxnQkFBZ0I7QUFDaEMsT0FBT0MsY0FBYyxrQkFBa0I7QUFDdkMsT0FBT0MsYUFBYSxVQUFVO0FBQzlCLFlBQVlDLFFBQVEsS0FBSztBQUN6QixZQUFZQyxVQUFVLE9BQU87QUFFN0JDLFdBQVdDLE9BQU8sR0FBSUw7QUFFdEIsTUFBTU0sT0FBT1AsSUFBSVEsUUFBUTtBQUd6QixTQUFTQyxNQUFNLFFBQVEsU0FBUztBQUNoQyxPQUFPQyxXQUFXLFFBQVE7QUFFMUIsTUFBTUMsWUFBWUwsUUFBUU0sU0FBUyxDQUFDVCxHQUFHVSxJQUFJO0FBRTNDLE1BQU1DLFVBQVVaO0FBRWhCWSxRQUFRQyxHQUFHLENBQUMsTUFBTSxPQUFPQyxLQUErRUM7SUFDcEcsSUFBSUMsVUFBVUYsSUFBSUcsTUFBTSxDQUFDLEVBQUU7SUFDM0IsSUFBSSxDQUFDRCxTQUFTO1FBQ1ZELElBQUlHLE1BQU0sQ0FBQyxLQUFLQyxHQUFHO0lBQ3ZCO0lBQ0EsSUFBSUMsUUFBUUMsR0FBRyxDQUFDQyxnQkFBZ0IsS0FBS0MsV0FBVztRQUM1QyxNQUFNLElBQUlDLE1BQU07SUFDcEI7SUFDQVIsVUFBVWQsS0FBS3VCLElBQUksQ0FBQ0wsUUFBUUMsR0FBRyxDQUFDQyxnQkFBZ0IsRUFBRU47SUFFbEQsTUFBTVUsSUFBSSxBQUFDWixJQUFJYSxLQUFLLENBQUNDLEtBQUssS0FBS0wsWUFBYUEsWUFBWU0sU0FBU2YsSUFBSWEs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